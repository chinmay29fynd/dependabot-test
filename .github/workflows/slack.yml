name: Dependabot PR Alerts

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read
  security-events: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GIT_PAT }}
          alert-lookup: true
          compat-lookup: true
          
      - name: Get vulnerabilities this PR fixes
        id: pr-vulnerabilities
        run: |
          # Get the package name and version being updated
          PACKAGE_NAME="${{ steps.dependabot-metadata.outputs.dependency-names }}"
          NEW_VERSION="${{ steps.dependabot-metadata.outputs.new-version }}"
          PREVIOUS_VERSION="${{ steps.dependabot-metadata.outputs.previous-version }}"
          
          # Get Dependabot alerts for this specific package
          ALERTS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GIT_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/dependabot/alerts")
          
          # Filter alerts for the specific package being updated
          PACKAGE_ALERTS=$(echo "$ALERTS_RESPONSE" | jq -r --arg pkg "$PACKAGE_NAME" \
            '.[] | select(.security_vulnerability.package.name == $pkg and .state == "open")')
          
          # Get vulnerability details for this specific package
          VULNERABILITY_DETAILS=$(echo "$PACKAGE_ALERTS" | jq -r \
            '"â€¢ \(.security_vulnerability.severity): \(.security_vulnerability.summary) (\(.security_vulnerability.vulnerable_version_range) â†’ \(.security_vulnerability.first_patched_version))"' | head -5)
          
          # Count vulnerabilities being fixed
          VULNERABILITY_COUNT=$(echo "$PACKAGE_ALERTS" | jq -r '.security_vulnerability.severity' | wc -l)
          
          # Get GHSA IDs being fixed
          GHSA_IDS=$(echo "$PACKAGE_ALERTS" | jq -r '.security_vulnerability.ghsa_id' | tr '\n' ', ' | sed 's/,$//')
          
          # Get CVSS scores
          CVSS_SCORES=$(echo "$PACKAGE_ALERTS" | jq -r '.security_vulnerability.cvss.score' | tr '\n' ', ' | sed 's/,$//')
          
          echo "vulnerability-count=$VULNERABILITY_COUNT" >> $GITHUB_OUTPUT
          echo "ghsa-ids=$GHSA_IDS" >> $GITHUB_OUTPUT
          echo "cvss-scores=$CVSS_SCORES" >> $GITHUB_OUTPUT
          echo "vulnerability-details<<EOF" >> $GITHUB_OUTPUT
          echo "$VULNERABILITY_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Found $VULNERABILITY_COUNT vulnerabilities being fixed for $PACKAGE_NAME"
          echo "Vulnerability details:"
          echo "$VULNERABILITY_DETAILS"
          
      - name: Notify Slack about Dependabot PR
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#test-dep-bot'
          text: |
            ğŸš¨ *Dependabot Security Update*
            
            *Repository:* ${{ github.repository }}
            *PR Number:* #${{ github.event.pull_request.number }}
            *Branch:* ${{ github.event.pull_request.head.ref }}
            
            *ğŸ“¦ Dependencies Updated:*
            ${{ steps.dependabot-metadata.outputs.dependency-names }}
            
            *ğŸ”§ Update Details:*
            â€¢ *Type:* ${{ steps.dependabot-metadata.outputs.dependency-type }}
            â€¢ *Update Type:* ${{ steps.dependabot-metadata.outputs.update-type || 'Version update' }}
            â€¢ *Package Ecosystem:* ${{ steps.dependabot-metadata.outputs.package-ecosystem }}
            â€¢ *Directory:* ${{ steps.dependabot-metadata.outputs.directory }}
            â€¢ *Target Branch:* ${{ steps.dependabot-metadata.outputs.target-branch }}
            
            * Version Changes:*
            â€¢ *From:* ${{ steps.dependabot-metadata.outputs.previous-version || 'N/A' }}
            â€¢ *To:* ${{ steps.dependabot-metadata.outputs.new-version || 'N/A' }}
            
            *ğŸ›¡ï¸ Vulnerabilities This PR Fixes:*
            ${{ steps.pr-vulnerabilities.outputs.vulnerability-count != '0' && format('ğŸš¨ *{0} vulnerabilities being fixed*', steps.pr-vulnerabilities.outputs.vulnerability-count) || 'ğŸ›¡ï¸ *No direct vulnerabilities detected*' }}
            ${{ steps.pr-vulnerabilities.outputs.ghsa-ids && format('â€¢ *GHSA IDs:* {0}', steps.pr-vulnerabilities.outputs.ghsa-ids) || 'â€¢ *GHSA IDs:* Not available' }}
            ${{ steps.pr-vulnerabilities.outputs.cvss-scores && format('â€¢ *CVSS Scores:* {0}', steps.pr-vulnerabilities.outputs.cvss-scores) || 'â€¢ *CVSS Scores:* Not available' }}
            
            ${{ steps.pr-vulnerabilities.outputs.vulnerability-count != '0' && '*Vulnerability Details:*' || '' }}
            ${{ steps.pr-vulnerabilities.outputs.vulnerability-details }}
            
            *ğŸ“ˆ Compatibility:*
            ${{ steps.dependabot-metadata.outputs.compatibility-score && steps.dependabot-metadata.outputs.compatibility-score != '0' && format('â€¢ *Compatibility Score:* {0}', steps.dependabot-metadata.outputs.compatibility-score) || 'â€¢ *Compatibility Score:* Not available' }}
            
            *ğŸ“‹ Summary:*
            Updates ${{ steps.dependabot-metadata.outputs.dependency-names }} to fix ${{ steps.pr-vulnerabilities.outputs.vulnerability-count }} security vulnerabilities and improve dependency health.
            
            <${{ github.event.pull_request.html_url }}|View Dependabot PR>
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 