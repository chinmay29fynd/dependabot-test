name: Dependabot PR Alerts

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read
  security-events: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          alert-lookup: true
          compat-lookup: true
          
      - name: Get repository security alerts
        id: security-alerts
        run: |
          # Get all security alerts for this repository
          ALERTS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/vulnerability-alerts")
          
          # Count open alerts
          OPEN_ALERTS=$(echo "$ALERTS_RESPONSE" | jq -r '.[] | select(.state == "open") | .security_vulnerability.severity' | wc -l)
          
          # Get alert details
          ALERT_DETAILS=$(echo "$ALERTS_RESPONSE" | jq -r '.[] | select(.state == "open") | "\(.security_vulnerability.severity): \(.security_vulnerability.package.name) - \(.security_vulnerability.vulnerable_version_range)"' | head -3)
          
          echo "open-alerts-count=$OPEN_ALERTS" >> $GITHUB_OUTPUT
          echo "alert-details<<EOF" >> $GITHUB_OUTPUT
          echo "$ALERT_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Found $OPEN_ALERTS open security alerts"
          echo "Alert details:"
          echo "$ALERT_DETAILS"
          
      - name: Notify Slack about Dependabot PR
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#test-dep-bot'
          text: |
            ğŸš¨ *Dependabot Security Update*
            
            *Repository:* ${{ github.repository }}
            *PR Number:* #${{ github.event.pull_request.number }}
            *Branch:* ${{ github.event.pull_request.head.ref }}
            
            *ğŸ“¦ Dependencies Updated:*
            ${{ steps.dependabot-metadata.outputs.dependency-names }}
            
            *ğŸ”§ Update Details:*
            â€¢ *Type:* ${{ steps.dependabot-metadata.outputs.dependency-type }}
            â€¢ *Update Type:* ${{ steps.dependabot-metadata.outputs.update-type || 'Version update' }}
            â€¢ *Package Ecosystem:* ${{ steps.dependabot-metadata.outputs.package-ecosystem }}
            â€¢ *Directory:* ${{ steps.dependabot-metadata.outputs.directory }}
            â€¢ *Target Branch:* ${{ steps.dependabot-metadata.outputs.target-branch }}
            
            * Version Changes:*
            â€¢ *From:* ${{ steps.dependabot-metadata.outputs.previous-version || 'N/A' }}
            â€¢ *To:* ${{ steps.dependabot-metadata.outputs.new-version || 'N/A' }}
            
            *ğŸ›¡ï¸ Security Information:*
            ${{ steps.dependabot-metadata.outputs.alert-state == 'OPEN' && 'ğŸš¨ *SECURITY ALERT DETECTED*' || 'ğŸ›¡ï¸ *Security vulnerability fix*' }}
            â€¢ *Alert State:* ${{ steps.dependabot-metadata.outputs.alert-state || 'No direct security alert' }}
            â€¢ *GHSA ID:* ${{ steps.dependabot-metadata.outputs.ghsa-id || 'Not available' }}
            â€¢ *CVSS Score:* ${{ steps.dependabot-metadata.outputs.cvss != '0' && steps.dependabot-metadata.outputs.cvss || 'Not available' }}
            â€¢ *Open Security Alerts in Repo:* ${{ steps.security-alerts.outputs.open-alerts-count }}
            
            ${{ steps.security-alerts.outputs.open-alerts-count != '0' && format('*Active Alerts:*\n{0}', steps.security-alerts.outputs.alert-details) || '' }}
            
            *ğŸ“ˆ Compatibility:*
            â€¢ *Compatibility Score:* ${{ steps.dependabot-metadata.outputs.compatibility-score != '0' && steps.dependabot-metadata.outputs.compatibility-score || 'Not available' }}
            
            *ğŸ“‹ Summary:*
            Updates ${{ steps.dependabot-metadata.outputs.dependency-names }} to fix security vulnerabilities and improve dependency health.
            
            <${{ github.event.pull_request.html_url }}|View Dependabot PR>
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 