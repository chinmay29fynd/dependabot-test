name: Dependabot PR Alerts

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read
  security-events: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GIT_PAT }}
          alert-lookup: true
          compat-lookup: true
          
      - name: Get vulnerabilities this PR fixes
        id: pr-vulnerabilities
        run: |
          # Get the package names being updated (split by comma if multiple)
          PACKAGE_NAMES="${{ steps.dependabot-metadata.outputs.dependency-names }}"
          
          # Check if dependabot metadata already found a security alert
          ALERT_STATE="${{ steps.dependabot-metadata.outputs.alert-state }}"
          GHSA_ID="${{ steps.dependabot-metadata.outputs.ghsa-id }}"
          CVSS_SCORE="${{ steps.dependabot-metadata.outputs.cvss }}"
          
          echo "Alert state from metadata: $ALERT_STATE"
          echo "GHSA ID from metadata: $GHSA_ID"
          echo "CVSS from metadata: $CVSS_SCORE"
          
          # If dependabot metadata found a security alert, use that
          if [ "$ALERT_STATE" = "OPEN" ] && [ ! -z "$GHSA_ID" ]; then
            echo "Using security alert from dependabot metadata"
            
            # Get detailed vulnerability info from GitHub API
            VULN_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GIT_PAT }}" \
              "https://api.github.com/repos/${{ github.repository }}/dependabot/alerts")
            
            # Extract CVSS v3.1 score from the correct path in the API response
            CVSS_V3_SCORE=$(echo "$VULN_RESPONSE" | jq -r --arg ghsa "$GHSA_ID" \
              '.[] | select(.security_advisory.ghsa_id == $ghsa) | .security_advisory.cvss_severities.cvss_v3.score // empty')
            
            echo "Extracted CVSS v3.1 score: '$CVSS_V3_SCORE'"
            
            # Determine severity based on CVSS v2 score
            if [ "$CVSS_SCORE" -ge 7 ]; then
              SEVERITY_V2="High"
            elif [ "$CVSS_SCORE" -ge 4 ]; then
              SEVERITY_V2="Medium"
            else
              SEVERITY_V2="Low"
            fi
            
            # Determine severity based on CVSS v3.1 score - improved null checking
            if [ ! -z "$CVSS_V3_SCORE" ] && [ "$CVSS_V3_SCORE" != "null" ] && [ "$CVSS_V3_SCORE" != "N/A" ]; then
              # Convert to integer for comparison
              CVSS_V3_INT=$(echo "$CVSS_V3_SCORE" | bc -l | cut -d. -f1)
              if [ "$CVSS_V3_INT" -ge 7 ]; then
                SEVERITY_V3="High"
              elif [ "$CVSS_V3_INT" -ge 4 ]; then
                SEVERITY_V3="Medium"
              else
                SEVERITY_V3="Low"
              fi
              CVSS_V3_INFO="â€¢ CVSS v3.1: $CVSS_V3_SCORE/10 ($SEVERITY_V3 severity)"
            else
              CVSS_V3_INFO="â€¢ CVSS v3.1: Not available"
            fi
            
            echo "vulnerability-count=1" >> $GITHUB_OUTPUT
            echo "ghsa-ids=$GHSA_ID" >> $GITHUB_OUTPUT
            echo "cvss-scores=$CVSS_SCORE" >> $GITHUB_OUTPUT
            echo "vulnerability-details<<EOF" >> $GITHUB_OUTPUT
            echo "â€¢ CVSS v2: $CVSS_SCORE/10 ($SEVERITY_V2 severity)" >> $GITHUB_OUTPUT
            echo "$CVSS_V3_INFO" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Found 1 vulnerability from dependabot metadata"
          else
            # Fallback: Get Dependabot alerts for this repository
            ALERTS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GIT_PAT }}" \
              "https://api.github.com/repos/${{ github.repository }}/dependabot/alerts")
            
            # Convert comma-separated package names to array and check each one
            IFS=',' read -ra PACKAGE_ARRAY <<< "$PACKAGE_NAMES"
            
            ALL_VULNERABILITIES=""
            TOTAL_VULNERABILITIES=0
            ALL_GHSA_IDS=""
            ALL_CVSS_SCORES=""
            
            for PACKAGE in "${PACKAGE_ARRAY[@]}"; do
              # Trim whitespace
              PACKAGE=$(echo "$PACKAGE" | xargs)
              
              # Get vulnerabilities for this specific package
              PACKAGE_ALERTS=$(echo "$ALERTS_RESPONSE" | jq -r --arg pkg "$PACKAGE" \
                '.[] | select(.security_vulnerability.package.name == $pkg and .state == "open")')
              
              if [ ! -z "$PACKAGE_ALERTS" ]; then
                # Get vulnerability details for this package with better formatting
                PACKAGE_VULNERABILITIES=$(echo "$PACKAGE_ALERTS" | jq -r \
                  '"â€¢ \(.security_vulnerability.severity): \(.security_advisory.summary // "Security vulnerability") (\(.security_vulnerability.vulnerable_version_range) â†’ \(.security_vulnerability.first_patched_version.identifier))"')
                
                # Count vulnerabilities for this package
                PACKAGE_COUNT=$(echo "$PACKAGE_ALERTS" | jq -r '.security_vulnerability.severity' | wc -l)
                
                # Get GHSA IDs for this package - format as bullet points
                PACKAGE_GHSA_IDS=$(echo "$PACKAGE_ALERTS" | jq -r '.security_advisory.ghsa_id' | sed 's/^/â€¢ /' | tr '\n' '\n')
                
                # Get CVSS scores for this package - format as bullet points
                PACKAGE_CVSS_SCORES=$(echo "$PACKAGE_ALERTS" | jq -r '.security_advisory.cvss.score' | sed 's/^/â€¢ /' | tr '\n' '\n')
                
                # Add to totals
                TOTAL_VULNERABILITIES=$((TOTAL_VULNERABILITIES + PACKAGE_COUNT))
                ALL_VULNERABILITIES="$ALL_VULNERABILITIES$PACKAGE_VULNERABILITIES"
                
                if [ ! -z "$PACKAGE_GHSA_IDS" ]; then
                  if [ ! -z "$ALL_GHSA_IDS" ]; then
                    ALL_GHSA_IDS="$ALL_GHSA_IDS$PACKAGE_GHSA_IDS"
                  else
                    ALL_GHSA_IDS="$PACKAGE_GHSA_IDS"
                  fi
                fi
                
                if [ ! -z "$PACKAGE_CVSS_SCORES" ]; then
                  if [ ! -z "$ALL_CVSS_SCORES" ]; then
                    ALL_CVSS_SCORES="$ALL_CVSS_SCORES$PACKAGE_CVSS_SCORES"
                  else
                    ALL_CVSS_SCORES="$PACKAGE_CVSS_SCORES"
                  fi
                fi
                
                echo "Found $PACKAGE_COUNT vulnerabilities for package: $PACKAGE"
              fi
            done
            
            echo "vulnerability-count=$TOTAL_VULNERABILITIES" >> $GITHUB_OUTPUT
            echo "ghsa-ids=$ALL_GHSA_IDS" >> $GITHUB_OUTPUT
            echo "cvss-scores=$ALL_CVSS_SCORES" >> $GITHUB_OUTPUT
            echo "vulnerability-details<<EOF" >> $GITHUB_OUTPUT
            echo "$ALL_VULNERABILITIES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "Found $TOTAL_VULNERABILITIES total vulnerabilities being fixed"
            echo "Vulnerability details:"
            echo "$ALL_VULNERABILITIES"
          fi
          
      - name: Notify Slack about Dependabot PR
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#test-dep-bot'
          text: |
            ğŸš¨ *Dependabot Security Update*
            
            *Repository:* ${{ github.repository }}
            *PR Number:* #${{ github.event.pull_request.number }}
            *Branch:* ${{ github.event.pull_request.head.ref }}
            
            *ğŸ“¦ Dependencies Updated:*
            ${{ steps.dependabot-metadata.outputs.dependency-names }}
            
            *ğŸ”§ Update Details:*
            â€¢ *Type:* ${{ steps.dependabot-metadata.outputs.dependency-type }}
            â€¢ *Update Type:* ${{ steps.dependabot-metadata.outputs.update-type || 'Version update' }}
            â€¢ *Package Ecosystem:* ${{ steps.dependabot-metadata.outputs.package-ecosystem }}
            â€¢ *Directory:* ${{ steps.dependabot-metadata.outputs.directory }}
            â€¢ *Target Branch:* ${{ steps.dependabot-metadata.outputs.target-branch }}
            
            * Version Changes:*
            â€¢ *From:* ${{ steps.dependabot-metadata.outputs.previous-version || 'N/A' }}
            â€¢ *To:* ${{ steps.dependabot-metadata.outputs.new-version || 'N/A' }}
            
            *ğŸ›¡ï¸ Vulnerabilities This PR Fixes:*
            ${{ steps.pr-vulnerabilities.outputs.vulnerability-count != '0' && format('ğŸš¨ *{0} vulnerabilities being fixed*', steps.pr-vulnerabilities.outputs.vulnerability-count) || 'ğŸ›¡ï¸ *No direct vulnerabilities detected*' }}
            
            ${{ steps.pr-vulnerabilities.outputs.ghsa-ids && '*GHSA IDs:*' || '' }}
            ${{ steps.pr-vulnerabilities.outputs.ghsa-ids }}
            
            ${{ steps.pr-vulnerabilities.outputs.cvss-scores && '*CVSS Scores:*' || '' }}
            ${{ steps.pr-vulnerabilities.outputs.cvss-scores }}
            
            ${{ steps.pr-vulnerabilities.outputs.vulnerability-count != '0' && '*Vulnerability Details:*' || '' }}
            ${{ steps.pr-vulnerabilities.outputs.vulnerability-details }}
            
            *ğŸ“ˆ Compatibility:*
            ${{ steps.dependabot-metadata.outputs.compatibility-score && steps.dependabot-metadata.outputs.compatibility-score != '0' && format('â€¢ *Compatibility Score:* {0}', steps.dependabot-metadata.outputs.compatibility-score) || 'â€¢ *Compatibility Score:* Not available' }}
            
            *ğŸ“‹ Summary:*
            Updates ${{ steps.dependabot-metadata.outputs.dependency-names }} to fix ${{ steps.pr-vulnerabilities.outputs.vulnerability-count }} security vulnerabilities and improve dependency health.
            
            <${{ github.event.pull_request.html_url }}|View Dependabot PR>
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}